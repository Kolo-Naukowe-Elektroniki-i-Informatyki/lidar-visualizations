#/bin/bash

# This script installs RPLIDAR SDK.

# _log prints its first argument to the standard output, if the
# global variable verbose is set to true. If it is false, it does
# nothing.
_log() {
  if [ $verbose = true ]; then
    printf "$1"
  fi
}

set -e

verbose=false
if [[ "$1" = "-v" || "$1" = "--verbose" ]]; then
  verbose=true
fi

rplidar_url="https://github.com/Slamtec/rplidar_sdk.git"

if [ -d rplidar_sdk ]; then
  printf "install_rplidar: rplidar_sdk directory already exists\n"
  exit 1
fi

_log "install_rplidar: cloning rplidar_sdk..."
git clone "$rplidar_url" &>/dev/null
_log "ok\n"

# rplidar_sdk/sdk/sdk/include/rplidar.h includes "hal/types.h"m
# but it cannot be found with the default rplidar_sdk project structure.
# (It's probably some bug made by the rplidar_sdk authors)
# That's why we're copying the hal folder (under "rplidar_sdk/sdk/sdk/src/hal")
# to rplidar_sdk/sdk/sdk/include/hal.
# Thanks to this sly move, the linker will be able to find it.

_log "install_rplidar: moving the hal directory..."
cp -r rplidar_sdk/sdk/sdk/src/hal rplidar_sdk/sdk/sdk/include
_log "ok\n"

_log "install_rplidar: making the sdk..."
cd rplidar_sdk/sdk && make &>/dev/null
_log "ok\n"

printf "install_rplidar: done\n"
